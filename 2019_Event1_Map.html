import pandas as pd
import pgeocode
import folium
from folium.plugins import MarkerCluster # for clustering the markers

import branca
import branca.colormap as cm
import math

df = pd.read_excel('2019 Event1_Analytics.xlsx')

df = df.iloc[:, [9,15]]
df = df[df['Total From Participant($)'] != 0].dropna()
df['Address  -  Participant ZIP/Postal Code'] = df['Address  -  Participant ZIP/Postal Code'].astype(str).str[:5]

#Generating dataset

#Defining function to create associated coordinates for zipcodes

def geocode(zipcode):
    location = nomi.query_postal_code(zipcode)
    return location.latitude, location.longitude

df[['Latitude', 'Longitude']] = df['Address  -  Participant ZIP/Postal Code'].apply(lambda x: pd.Series(geocode(x)))


map = folium.Map(location = [39.8283, -98.5795])

#Fitting map based on SW and NE bounds
sw = df[['Latitude', 'Longitude']].min().values.tolist()
ne = df[['Latitude', 'Longitude']].max().values.tolist()

map.fit_bounds([sw, ne]) 

#creating mapcluster object
marker_cluster = MarkerCluster().add_to(map)

#creating colormap
min_cval, max_cval = math.log(min(df['Total From Participant($)'])), math.log(max(df['Total From Participant($)']))
print(min_cval, max_cval)

#YlGnBu_09

colormap = cm.linear.PuBuGn_09.scale(min_cval, max_cval)
colormap.caption = "log(Donation Amount)"
map.add_child(colormap)

df.apply(lambda row: folium.Circle(location = [row['Latitude'], row['Longitude']],
                                  radius = 75*math.log(row['Total From Participant($)']),
                                  fill = True,
                                  opacity = 1,
                                  fill_opacity = 0.9,
                                  tooltip = folium.Tooltip('$' + str(row['Total From Participant($)']), 
                                                      permanent = True),
                                  color = colormap(math.log(row['Total From Participant($)']))
                                  ).add_to(marker_cluster),
         axis=1)

#map.save('map_v2.html')
map